# BSD-000-02: 共通 アーキテクチャ

## 概要

harborix全サービス共通のシステムアーキテクチャを定義する。

## システム構成図

```text
┌─────────────────────────────────────────────────────────────────┐
│                          クライアント                            │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │harborix  │ │coinship  │ │libship   │ │fanship   │           │
│  │(React)   │ │(React)   │ │(Next.js) │ │(React)   │           │
│  └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘           │
│       │            │            │            │                  │
│       └────────────┴─────┬──────┴────────────┘                  │
│                          │                                       │
│              ┌───────────┴───────────┐                          │
│              │   @harborix/ui        │                          │
│              │   共通UIライブラリ     │                          │
│              └───────────────────────┘                          │
└─────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                        AWS Cognito                               │
│                      （認証・セッション管理）                      │
└─────────────────────────────────────────────────────────────────┘
                           │ JWT
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                        バックエンド                              │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │harborix  │ │coinship  │ │libship   │ │fanship   │           │
│  │(Node.js) │ │(Rust)    │ │(Next.js) │ │(Go)      │           │
│  │tRPC      │ │Axum/REST │ │API Routes│ │Gin/REST  │           │
│  └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘           │
│       │            │            │            │                  │
│       └────────────┴─────┬──────┴────────────┘                  │
└──────────────────────────┼──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Supabase                                     │
│  ┌─────────────────────┐  ┌─────────────────────┐               │
│  │   PostgreSQL        │  │   Storage           │               │
│  │   （データベース）    │  │   （ファイル保存）   │               │
│  └─────────────────────┘  └─────────────────────┘               │
└─────────────────────────────────────────────────────────────────┘
```

## モジュール構成

### パッケージ構成

```text
harborix/
├── packages/
│   ├── ui/              # @harborix/ui - 共通UIライブラリ
│   ├── harborix-web/    # ダッシュボード (React + tRPC)
│   ├── harborix-api/    # ダッシュボードAPI (Node.js + tRPC)
│   ├── coinship-web/    # 家計簿フロント (React)
│   ├── coinship-api/    # 家計簿API (Rust + Axum)
│   ├── libship/         # 読書管理 (Next.js App Router)
│   ├── fanship-web/     # 推し活フロント (React)
│   └── fanship-api/     # 推し活API (Go + Gin)
├── infra/               # Terraform
├── docs/                # ドキュメント
└── scripts/             # 共通スクリプト
```

### 依存関係

```text
@harborix/ui
    ↑
    ├── harborix-web
    ├── coinship-web
    ├── libship
    └── fanship-web

各サービスは独立してデプロイ可能
```

## 認証アーキテクチャ

### AWS Cognito + Amplify

| 項目 | 内容 |
| ---- | ---- |
| User Pool | ユーザー管理、認証 |
| Identity Pool | （使用しない - JWT認証のみ） |
| Amplify UI | ログイン画面コンポーネント |

### SSO認証フロー

```text
1. ユーザーがharborixにアクセス
       ↓
2. 未認証の場合、Amplify Authenticatorでログイン画面表示
       ↓
3. Cognitoで認証、JWTトークン発行
       ↓
4. harborix基盤がhttpOnly Cookieにトークンを設定
   - domain: .harborix.example.com（サブドメイン共有）
   - secure: true（HTTPS必須）
   - httpOnly: true（XSS対策）
   - sameSite: Lax
       ↓
5. 他のアプリ（coinship.harborix.example.com等）にアクセス
       ↓
6. CookieからJWTを自動送信、認証済み（再ログイン不要）
```

### ドメイン構成

| サービス | ドメイン |
| -------- | -------- |
| harborix基盤 | harborix.example.com |
| coinship | coinship.harborix.example.com |
| libship | libship.harborix.example.com |
| fanship | fanship.harborix.example.com |

### セッション管理

| 項目 | 内容 |
| ---- | ---- |
| セッション保持 | Cognito管理（デフォルト30日） |
| トークン管理 | ID Token + Access Token + Refresh Token |
| リフレッシュ | harborix基盤のトークンリフレッシュエンドポイント経由 |
| 保存先 | httpOnly Cookie（domain=.harborix.example.com） |

### トークン構成

| トークン | 用途 | 有効期限 |
| -------- | ---- | -------- |
| ID Token | ユーザー情報取得 | 1時間 |
| Access Token | API認証 | 1時間 |
| Refresh Token | トークン更新 | 30日 |

## データフロー

### 読み取りフロー

```text
[クライアント]
    │
    │ TanStack Query / SWR / Server Actions
    ▼
[API層]
    │ harborix: tRPC
    │ coinship: REST (Axum)
    │ libship: Server Actions
    │ fanship: REST (Gin)
    ▼
[Supabase PostgreSQL]
```

### 書き込みフロー

```text
[クライアント]
    │
    │ フォーム送信 (React 19 Forms / React Hook Form)
    ▼
[バリデーション]
    │ Zod スキーマ検証
    ▼
[API層]
    │ Cognito JWT 検証
    ▼
[Supabase PostgreSQL]
```

## セキュリティ設計

### 認証・認可

| 項目 | 方針 |
| ---- | ---- |
| 認証方式 | AWS Cognito（JWT） |
| 認可方式 | JWTクレームベース（user_id で所有権確認） |
| CORS | 許可オリジン: 各アプリのドメインのみ |

### JWT検証

各バックエンドで以下を検証:

1. 署名の検証（Cognito公開鍵）
2. 有効期限の確認（exp）
3. 発行者の確認（iss = Cognito User Pool）
4. オーディエンスの確認（aud = Client ID）

### データ保護

| 項目 | 方針 |
| ---- | ---- |
| 通信暗号化 | HTTPS必須（TLS 1.2以上） |
| データ暗号化 | Supabaseのデフォルト暗号化（AES-256） |
| 機密情報 | 環境変数で管理、コードに含めない |

### Cookie セキュリティ

| 項目 | 設定 |
| ---- | ---- |
| httpOnly | true（JavaScriptからのアクセスを防止） |
| secure | true（HTTPS接続のみで送信） |
| sameSite | Lax（CSRF対策） |
| domain | .harborix.example.com（サブドメイン共有） |
| path | / |
| max-age | 3600（1時間、Access Token有効期限に合わせる） |

### 共有リンクのセキュリティ

coinship（パートナー招待）やfanship（コンテンツ共有）で使用する共有トークンには以下を適用する。

| 項目 | 方針 |
| ---- | ---- |
| トークン生成 | 暗号学的に安全な乱数（crypto.randomUUID() 等） |
| トークン長 | 最低32文字 |
| レート制限 | 招待リンク生成は1ユーザーあたり10件/時間 |
| 有効期限 | 招待リンクは72時間、共有リンクは無期限（手動無効化可能） |

### CORS設定

| 環境 | 許可オリジン |
| ---- | ------------ |
| 開発 | localhost:3000, localhost:5173 等 |
| 本番 | *.harborix.example.com（サブドメインのみ許可） |

## ホスティング

| サービス | ホスティング先 | 備考 |
| -------- | -------------- | ---- |
| harborix-web | Vercel | React SPA |
| harborix-api | Fly.io | Node.js + Docker |
| coinship-web | Vercel | React SPA |
| coinship-api | Fly.io | Rust + Docker |
| libship | Vercel | Next.js (API Routes含む) |
| fanship-web | Vercel | React SPA |
| fanship-api | Fly.io | Go + Docker |

### Fly.io選定理由

| 項目 | 内容 |
| ---- | ---- |
| Docker対応 | 全言語（Node.js/Rust/Go）統一的にデプロイ可能 |
| 無料枠 | 小規模個人プロジェクトに十分 |
| リージョン | 東京リージョン対応 |
| スケーリング | 必要に応じてスケールアウト可能 |

### コスト見積もり

| 項目 | 無料枠 | 備考 |
| ---- | ------ | ---- |
| Vercel | 100GB帯域/月 | 4つのフロントエンドで共有 |
| Fly.io | 3 shared-cpu-1x VM | 3サービスで無料枠を使い切る可能性あり |
| Supabase | 500MB DB, 1GB Storage | 全サービスで1プロジェクトを共有 |
| AWS Cognito | 50,000 MAU | 個人利用では十分 |

※Fly.ioの無料枠超過時は、利用頻度の低いサービスをスケールダウン（0台→リクエスト時に起動）で対応する。

## 変更履歴

- 2026-02-12: SSO方式をサブドメイン共有Cookie（httpOnly）に変更
- 2026-02-12: ドメイン構成、Cookieセキュリティ、共有リンクセキュリティを追加
- 2026-02-12: コスト見積もりを追加
- 2026-02-12: バックエンドホスティングをFly.ioに決定
- 2026-02-11: アーキテクチャ詳細を記載
- 2026-02-11: 初版作成（テンプレート）
