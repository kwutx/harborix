# BSD-000-02: 共通 アーキテクチャ

## 概要

harborix全サービス共通のシステムアーキテクチャを定義する。

## システム構成図

```text
┌─────────────────────────────────────────────────────────────────┐
│                          クライアント                            │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │harborix  │ │coinship  │ │libship   │ │fanship   │           │
│  │(React)   │ │(React)   │ │(Next.js) │ │(React)   │           │
│  └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘           │
│       │            │            │            │                  │
│       └────────────┴─────┬──────┴────────────┘                  │
│                          │                                       │
│              ┌───────────┴───────────┐                          │
│              │   @harborix/ui        │                          │
│              │   共通UIライブラリ     │                          │
│              └───────────────────────┘                          │
└─────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                        AWS Cognito                               │
│                      （認証・セッション管理）                      │
└─────────────────────────────────────────────────────────────────┘
                           │ JWT
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                        バックエンド                              │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │harborix  │ │coinship  │ │libship   │ │fanship   │           │
│  │(Node.js) │ │(Rust)    │ │(Next.js) │ │(Go)      │           │
│  │tRPC      │ │Axum/REST │ │API Routes│ │Gin/REST  │           │
│  └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘           │
│       │            │            │            │                  │
│       └────────────┴─────┬──────┴────────────┘                  │
└──────────────────────────┼──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Supabase                                     │
│  ┌─────────────────────┐  ┌─────────────────────┐               │
│  │   PostgreSQL        │  │   Storage           │               │
│  │   （データベース）    │  │   （ファイル保存）   │               │
│  └─────────────────────┘  └─────────────────────┘               │
└─────────────────────────────────────────────────────────────────┘
```

## モジュール構成

### パッケージ構成

```text
harborix/
├── packages/
│   ├── ui/              # @harborix/ui - 共通UIライブラリ
│   ├── harborix-web/    # ダッシュボード (React + tRPC)
│   ├── harborix-api/    # ダッシュボードAPI (Node.js + tRPC)
│   ├── coinship-web/    # 家計簿フロント (React)
│   ├── coinship-api/    # 家計簿API (Rust + Axum)
│   ├── libship/         # 読書管理 (Next.js App Router)
│   ├── fanship-web/     # 推し活フロント (React)
│   └── fanship-api/     # 推し活API (Go + Gin)
├── infra/               # Terraform
├── docs/                # ドキュメント
└── scripts/             # 共通スクリプト
```

### 依存関係

```text
@harborix/ui
    ↑
    ├── harborix-web
    ├── coinship-web
    ├── libship
    └── fanship-web

各サービスは独立してデプロイ可能
```

## 認証アーキテクチャ

### AWS Cognito + Amplify

| 項目 | 内容 |
| ---- | ---- |
| User Pool | ユーザー管理、認証 |
| Identity Pool | （使用しない - JWT認証のみ） |
| Amplify UI | ログイン画面コンポーネント |

### SSO認証フロー

```text
1. ユーザーがharborixにアクセス
       ↓
2. 未認証の場合、Amplify Authenticatorでログイン画面表示
       ↓
3. Cognitoで認証、JWTトークン発行
       ↓
4. トークンをlocalStorage/cookieに保存
       ↓
5. 他のアプリ（coinship等）にアクセス
       ↓
6. 保存済みトークンで認証済み（再ログイン不要）
```

### セッション管理

| 項目 | 内容 |
| ---- | ---- |
| セッション保持 | Cognito管理（デフォルト30日） |
| トークン管理 | ID Token + Access Token + Refresh Token |
| リフレッシュ | Amplify SDKが自動リフレッシュ |
| 保存先 | localStorage（デフォルト） |

### トークン構成

| トークン | 用途 | 有効期限 |
| -------- | ---- | -------- |
| ID Token | ユーザー情報取得 | 1時間 |
| Access Token | API認証 | 1時間 |
| Refresh Token | トークン更新 | 30日 |

## データフロー

### 読み取りフロー

```text
[クライアント]
    │
    │ TanStack Query / SWR / Server Actions
    ▼
[API層]
    │ harborix: tRPC
    │ coinship: REST (Axum)
    │ libship: Server Actions
    │ fanship: REST (Gin)
    ▼
[Supabase PostgreSQL]
```

### 書き込みフロー

```text
[クライアント]
    │
    │ フォーム送信 (React 19 Forms / React Hook Form)
    ▼
[バリデーション]
    │ Zod スキーマ検証
    ▼
[API層]
    │ Cognito JWT 検証
    ▼
[Supabase PostgreSQL]
```

## セキュリティ設計

### 認証・認可

| 項目 | 方針 |
| ---- | ---- |
| 認証方式 | AWS Cognito（JWT） |
| 認可方式 | JWTクレームベース（user_id で所有権確認） |
| CORS | 許可オリジン: 各アプリのドメインのみ |

### JWT検証

各バックエンドで以下を検証:

1. 署名の検証（Cognito公開鍵）
2. 有効期限の確認（exp）
3. 発行者の確認（iss = Cognito User Pool）
4. オーディエンスの確認（aud = Client ID）

### データ保護

| 項目 | 方針 |
| ---- | ---- |
| 通信暗号化 | HTTPS必須（TLS 1.2以上） |
| データ暗号化 | Supabaseのデフォルト暗号化（AES-256） |
| 機密情報 | 環境変数で管理、コードに含めない |

### CORS設定

| 環境 | 許可オリジン |
| ---- | ------------ |
| 開発 | localhost:3000, localhost:5173 等 |
| 本番 | harborix.example.com, *.harborix.example.com |

## ホスティング

| サービス | ホスティング先 | 備考 |
| -------- | -------------- | ---- |
| harborix-web | Vercel | React SPA |
| harborix-api | Fly.io | Node.js + Docker |
| coinship-web | Vercel | React SPA |
| coinship-api | Fly.io | Rust + Docker |
| libship | Vercel | Next.js (API Routes含む) |
| fanship-web | Vercel | React SPA |
| fanship-api | Fly.io | Go + Docker |

### Fly.io選定理由

| 項目 | 内容 |
| ---- | ---- |
| Docker対応 | 全言語（Node.js/Rust/Go）統一的にデプロイ可能 |
| 無料枠 | 小規模個人プロジェクトに十分 |
| リージョン | 東京リージョン対応 |
| スケーリング | 必要に応じてスケールアウト可能 |

## 変更履歴

- 2026-02-12: バックエンドホスティングをFly.ioに決定
- 2026-02-11: アーキテクチャ詳細を記載
- 2026-02-11: 初版作成（テンプレート）
