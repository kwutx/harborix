# BSD-000-01: 共通 技術スタック

## 概要

harborix全サービスで使用する技術スタックを定義する。

## 技術スタック一覧

### サービス別構成

| サービス | フロントエンド | バックエンド | DB |
| -------- | -------------- | ------------ | -- |
| harborix基盤 | React | TypeScript (Node.js) | Supabase PostgreSQL |
| coinship | React | Rust | Supabase PostgreSQL |
| libship | Next.js (App Router) | - (API Routes) | Supabase PostgreSQL |
| fanship | React | Go | Supabase PostgreSQL |

### フロントエンド詳細

| サービス | ルーティング | データ取得 | 状態管理 | フォーム | バリデーション |
| -------- | ------------ | ---------- | -------- | -------- | -------------- |
| harborix基盤 | React Router | tRPC + TanStack Query | Zustand | React 19 Forms | Zod |
| coinship | React Router | TanStack Query | Jotai | React Hook Form | Zod |
| libship | Next.js App Router | Server Actions | - (RSC) | React 19 Forms | Zod |
| fanship | React Router | SWR | Redux Toolkit | React Hook Form | Zod |

## 認証

### AWS Cognito + Amplify

| 項目 | 技術 | 説明 |
| ---- | ---- | ---- |
| 認証基盤 | AWS Cognito | ユーザー管理、認証、セッション管理 |
| フロントエンド | Amplify UI | Authenticatorコンポーネント |
| SDK | Amplify JS v6 | 認証API呼び出し |
| トークン | Cognito JWT | ID Token / Access Token |
| トークン保存 | httpOnly Cookie | サブドメイン共有（*.harborix.example.com） |

### 認証フロー

```text
[ユーザー]
    ↓ ログイン（Amplify Authenticator）
[AWS Cognito]
    ↓ JWT トークン発行
[harborix基盤]
    ↓ httpOnly Cookie に設定（domain=.harborix.example.com）
[各サービス]
    ├── harborix (tRPC) ← Cookie から JWT 検証
    ├── coinship (REST/Rust) ← Cookie から JWT 検証
    ├── libship (Server Actions) ← Cookie から JWT 検証
    └── fanship (REST/Go) ← Cookie から JWT 検証
```

※全サービスをサブドメイン（harborix.example.com, coinship.harborix.example.com 等）で運用し、httpOnly Cookie でトークンを共有することでSSOを実現する。

### Amplify Authenticator 使用例

```tsx
import { Authenticator } from '@aws-amplify/ui-react'
import '@aws-amplify/ui-react/styles.css'
import { setCookieToken } from '@/lib/auth'

function App() {
  return (
    <Authenticator>
      {({ signOut, user }) => {
        // ログイン成功時にhttpOnly Cookieにトークンを設定
        // ※実際にはAmplify認証イベントリスナーで処理
        return (
          <main>
            <h1>Welcome {user?.username}</h1>
            <button onClick={signOut}>Sign out</button>
          </main>
        )
      }}
    </Authenticator>
  )
}
```

## 共通技術

### フロントエンド共通

| 項目 | 技術 | 理由 |
| ---- | ---- | ---- |
| 言語 | TypeScript | 型安全、開発効率 |
| ビルドツール | Vite | 高速、モダン（Next.js以外） |
| UIライブラリ | @harborix/ui | 共通コンポーネント |
| スタイリング | Tailwind CSS | ユーティリティファースト |
| バリデーション | Zod | スキーマ定義、型推論 |
| テスト | Vitest + Testing Library | 高速、React標準 |

### バックエンド共通

| 項目 | 技術 | 理由 |
| ---- | ---- | ---- |
| データベース | Supabase PostgreSQL | マネージド、無料枠あり |
| ストレージ | Supabase Storage | 画像等のファイル保存 |
| API形式 | REST / tRPC | サービスにより異なる |

### インフラ

| 項目 | 技術 | 理由 |
| ---- | ---- | ---- |
| 認証 | AWS Cognito | マネージド認証、Amplify統合 |
| ホスティング (FE) | Vercel | Next.js最適、無料枠あり |
| ホスティング (BE) | （未定） | Rust/Go のホスティング先を検討 |
| IaC | Terraform | インフラのコード管理 |
| CI/CD | GitHub Actions | GitHub統合 |

## API設計

### harborix基盤: tRPC

| 項目 | 内容 |
| ---- | ---- |
| ライブラリ | tRPC v11 |
| クライアント | @trpc/react-query |
| トランスポート | HTTP |
| 認証 | Cognito JWT をcontextで検証 |

#### tRPC のメリット

- エンドツーエンドの型安全
- スキーマ定義不要（TypeScriptの型がそのまま使える）
- TanStack Query との統合

#### tRPC 実装例

```typescript
// サーバー側
const appRouter = router({
  user: router({
    me: protectedProcedure.query(({ ctx }) => {
      return ctx.user
    }),
  }),
})

// クライアント側
const { data: user } = trpc.user.me.useQuery()
// user は自動的に型付けされる
```

### coinship / fanship: REST API

| 項目 | 内容 |
| ---- | ---- |
| 形式 | REST |
| 認証 | Authorization: Bearer {Cognito JWT} |
| クライアント | TanStack Query / SWR |

### libship: Server Actions

| 項目 | 内容 |
| ---- | ---- |
| 形式 | Next.js Server Actions |
| 認証 | Cognito JWT (Cookie) |
| バリデーション | Zod |

## フォーム

### React 19 Forms (harborix, libship)

| 機能 | 用途 |
| ---- | ---- |
| `useActionState` | フォームアクションの状態管理 |
| `useFormStatus` | 送信中の状態取得 |
| `useOptimistic` | 楽観的更新 |

#### 使用例

```tsx
'use client'
import { useActionState } from 'react'
import { createUser } from './actions'

function CreateUserForm() {
  const [state, formAction, isPending] = useActionState(createUser, null)

  return (
    <form action={formAction}>
      <input name="email" type="email" required />
      <button disabled={isPending}>
        {isPending ? '送信中...' : '登録'}
      </button>
      {state?.error && <p>{state.error}</p>}
    </form>
  )
}
```

### React Hook Form (coinship, fanship)

- 業界標準のフォームライブラリ
- Zod との統合（zodResolver）
- 高パフォーマンス

## バックエンド言語

### TypeScript (Node.js) - harborix基盤

| 項目 | 内容 |
| ---- | ---- |
| ランタイム | Node.js v20 LTS |
| フレームワーク | Fastify + tRPC |
| 採用理由 | フロントエンドと言語統一、tRPC対応 |

### Rust - coinship

| 項目 | 内容 |
| ---- | ---- |
| フレームワーク | Axum |
| 採用理由 | 高パフォーマンス、メモリ安全、学習目的 |

### Go - fanship

| 項目 | 内容 |
| ---- | ---- |
| バージョン | 1.21以上 |
| フレームワーク | Gin |
| 採用理由 | シンプル、高パフォーマンス、クラウドネイティブ |

## 技術選定の方針

### 選定基準

1. **実務での普及度**: 業界で広く使われている技術を優先
2. **学習価値**: ポートフォリオとして価値のある技術
3. **開発効率**: 1人開発で現実的に運用できる
4. **コスト**: 無料枠を活用できる

### バックエンド言語を分けた理由

- ポートフォリオとしての技術幅を広げる
- 各言語の特性を学ぶ
- マイクロサービス的なアーキテクチャの経験

### 認証にCognitoを選んだ理由

- AWSの実務経験として価値がある
- Amplify UIで実装コストを削減
- マネージドで運用負荷が低い

## 変更履歴

- 2026-02-12: 認証のトークン保存をhttpOnly Cookie（サブドメイン共有）に変更
- 2026-02-11: 認証をAWS Cognito + Amplifyに変更
- 2026-02-11: harborixにtRPCを追加
- 2026-02-11: フォームをReact 19 Forms / React Hook Form + Zodに更新
- 2026-02-11: 技術スタック確定
- 2026-02-11: 初版作成（テンプレート）
