# BSD-000-05: 共通 インフラ設計

## 概要

harborixおよび各アプリのインフラストラクチャ設計を定義する。

## インフラ構成図

```text
┌─────────────────────────────────────────────────────────────────────────┐
│                              Internet                                    │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │         Cloudflare            │
                    │      (DNS / CDN / WAF)        │
                    └───────────────┬───────────────┘
                                    │
        ┌───────────────────────────┼───────────────────────────┐
        │                           │                           │
        ▼                           ▼                           ▼
┌───────────────┐         ┌───────────────┐         ┌───────────────┐
│    Vercel     │         │    Fly.io     │         │  AWS Cognito  │
│  (Frontend)   │         │   (Backend)   │         │    (認証)     │
├───────────────┤         ├───────────────┤         └───────────────┘
│ harborix-web  │         │ coinship-api  │
│ libship       │         │ (Rust/Axum)   │
│ (Next.js)     │         ├───────────────┤
│               │         │ fanship-api   │
│ coinship-web  │         │ (Go/Gin)      │
│ fanship-web   │         └───────┬───────┘
│ (React/Vite)  │                 │
└───────┬───────┘                 │
        │                         │
        └────────────┬────────────┘
                     │
                     ▼
           ┌───────────────────┐
           │     Supabase      │
           ├───────────────────┤
           │ PostgreSQL (DB)   │
           │ Storage (Files)   │
           │ Edge Functions    │
           └───────────────────┘
```

## サービス構成

### フロントエンド（Vercel）

| アプリ | フレームワーク | ドメイン |
| ------ | -------------- | -------- |
| harborix-web | React + Vite | harborix.app |
| coinship-web | React + Vite | coinship.harborix.app |
| libship | Next.js | libship.harborix.app |
| fanship-web | React + Vite | fanship.harborix.app |

### バックエンド（Fly.io）

| アプリ | 言語/FW | リージョン | インスタンス |
| ------ | ------- | ---------- | ------------ |
| coinship-api | Rust/Axum | nrt (東京) | 1 shared-cpu |
| fanship-api | Go/Gin | nrt (東京) | 1 shared-cpu |

※ libshipはNext.js Server Actionsを使用（Vercel内で完結）

### データベース（Supabase）

| 項目 | 設定 |
| ---- | ---- |
| プラン | Free（初期）→ Pro（必要時） |
| リージョン | Northeast Asia (Tokyo) |
| PostgreSQLバージョン | 15 |

### 認証（AWS Cognito）

| 項目 | 設定 |
| ---- | ---- |
| User Pool | harborix-users |
| リージョン | ap-northeast-1 (東京) |
| 認証方式 | メール/パスワード |

## ドメイン設計

### ドメイン構成

```text
harborix.app (メインドメイン)
├── harborix.app          → harborix-web (Vercel)
├── coinship.harborix.app → coinship-web (Vercel)
├── libship.harborix.app  → libship (Vercel)
├── fanship.harborix.app  → fanship-web (Vercel)
├── api.harborix.app      → harborix-api (Vercel/Edge)
├── coinship-api.harborix.app → coinship-api (Fly.io)
└── fanship-api.harborix.app  → fanship-api (Fly.io)
```

### DNS設定

| レコード | タイプ | 値 |
| -------- | ------ | -- |
| harborix.app | A | Vercel IP |
| *.harborix.app | CNAME | cname.vercel-dns.com |
| coinship-api.harborix.app | CNAME | coinship-api.fly.dev |
| fanship-api.harborix.app | CNAME | fanship-api.fly.dev |

## CI/CD設計

### パイプライン概要

```text
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│  Push   │────>│  Build  │────>│  Test   │────>│ Deploy  │
│ (main)  │     │         │     │         │     │         │
└─────────┘     └─────────┘     └─────────┘     └─────────┘
```

### GitHub Actions ワークフロー

#### フロントエンド（Vercel自動デプロイ）

```yaml
# Vercel GitHub Integration により自動化
# - main push → Production Deploy
# - PR → Preview Deploy
```

#### バックエンド（Fly.io）

```yaml
name: Deploy Backend

on:
  push:
    branches: [main]
    paths:
      - 'packages/coinship-api/**'
      - 'packages/fanship-api/**'

jobs:
  deploy-coinship:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: superfly/flyctl-actions/setup-flyctl@master
      - run: flyctl deploy --remote-only
        working-directory: packages/coinship-api
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

  deploy-fanship:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: superfly/flyctl-actions/setup-flyctl@master
      - run: flyctl deploy --remote-only
        working-directory: packages/fanship-api
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
```

### ブランチ戦略

```text
main (本番)
  │
  └── feature/* (機能開発)
        │
        └── PR → main (マージ → 自動デプロイ)
```

| ブランチ | 用途 | デプロイ先 |
| -------- | ---- | ---------- |
| main | 本番 | Production |
| feature/* | 機能開発 | Preview (PR時) |

## 環境変数管理

### 環境変数一覧

#### フロントエンド共通

| 変数名 | 説明 | 設定場所 |
| ------ | ---- | -------- |
| VITE_SUPABASE_URL | Supabase URL | Vercel |
| VITE_SUPABASE_ANON_KEY | Supabase匿名キー | Vercel |
| VITE_COGNITO_USER_POOL_ID | Cognito User Pool ID | Vercel |
| VITE_COGNITO_CLIENT_ID | Cognito Client ID | Vercel |
| VITE_COGNITO_REGION | Cognitoリージョン | Vercel |

#### バックエンド共通

| 変数名 | 説明 | 設定場所 |
| ------ | ---- | -------- |
| DATABASE_URL | PostgreSQL接続文字列 | Fly.io Secrets |
| SUPABASE_SERVICE_KEY | Supabaseサービスキー | Fly.io Secrets |
| COGNITO_USER_POOL_ID | Cognito User Pool ID | Fly.io Secrets |
| JWT_SECRET | JWT署名キー | Fly.io Secrets |

### シークレット管理

```text
┌─────────────────┐
│   GitHub        │
│   Secrets       │
├─────────────────┤
│ FLY_API_TOKEN   │──────> GitHub Actions
│ VERCEL_TOKEN    │
└─────────────────┘

┌─────────────────┐
│   Vercel        │
│   Environment   │
├─────────────────┤
│ SUPABASE_*      │──────> Frontend Apps
│ COGNITO_*       │
└─────────────────┘

┌─────────────────┐
│   Fly.io        │
│   Secrets       │
├─────────────────┤
│ DATABASE_URL    │──────> Backend APIs
│ SUPABASE_*      │
│ JWT_SECRET      │
└─────────────────┘
```

## リソース制限

### Vercel (Free)

| リソース | 制限 |
| -------- | ---- |
| 帯域幅 | 100GB/月 |
| ビルド時間 | 100時間/月 |
| サーバーレス実行 | 100GB-時間/月 |
| 同時ビルド | 1 |

### Fly.io (Free)

| リソース | 制限 |
| -------- | ---- |
| VM | 3 shared-cpu-1x (256MB) |
| 永続ストレージ | 3GB |
| 帯域幅 | 160GB/月 |

### Supabase (Free)

| リソース | 制限 |
| -------- | ---- |
| データベース | 500MB |
| ストレージ | 1GB |
| 帯域幅 | 2GB/月 |
| Edge Functions | 500K呼び出し/月 |

### AWS Cognito (Free Tier)

| リソース | 制限 |
| -------- | ---- |
| MAU | 50,000ユーザー |

## 監視・アラート

### 監視項目

| 項目 | ツール | 閾値 |
| ---- | ------ | ---- |
| サイト死活 | Vercel Analytics | - |
| API死活 | Fly.io Metrics | - |
| エラー率 | Vercel/Fly.io Logs | 5%以上で確認 |
| レスポンス時間 | Vercel Analytics | 3秒以上で確認 |

### ログ

| サービス | ログ保持期間 | 確認方法 |
| -------- | ------------ | -------- |
| Vercel | 1時間 (Free) | Dashboard |
| Fly.io | 2日 | flyctl logs |
| Supabase | 1日 | Dashboard |

## バックアップ・リストア

### バックアップ方針

| 対象 | 方式 | 頻度 | 保持期間 |
| ---- | ---- | ---- | -------- |
| Supabase DB | 自動 | 日次 | 7日 |
| Supabase Storage | 手動 | 週次 | 30日 |
| コード | Git | 常時 | 永続 |

### リストア手順

1. Supabase Dashboard → Settings → Backups
2. 復元したい時点のバックアップを選択
3. "Restore" をクリック
4. 復元完了を確認

## スケーリング計画

### Phase 1（初期・無料枠）

```text
Vercel Free + Fly.io Free + Supabase Free
想定ユーザー: 〜10人
```

### Phase 2（小規模）

```text
Vercel Pro + Fly.io Scale + Supabase Pro
想定ユーザー: 〜100人
月額コスト: $45〜60
```

### Phase 3（中規模）

```text
Vercel Pro + Fly.io Dedicated + Supabase Pro
想定ユーザー: 〜1000人
月額コスト: $100〜150
```

## 構成管理（Terraform）

### ディレクトリ構成

```text
infra/
├── environments/
│   ├── dev/
│   │   └── main.tf
│   └── prod/
│       └── main.tf
├── modules/
│   ├── cognito/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── outputs.tf
│   └── supabase/
│       └── ...
└── terraform.tf
```

### 管理対象

| リソース | Terraform管理 | 備考 |
| -------- | ------------- | ---- |
| Cognito User Pool | ○ | AWS Provider |
| Supabase Project | △ | API経由で一部 |
| Vercel Project | ○ | Vercel Provider |
| Fly.io App | ○ | Fly Provider |
| Cloudflare DNS | ○ | Cloudflare Provider |

## 変更履歴

- 2026-02-13: 初版作成
