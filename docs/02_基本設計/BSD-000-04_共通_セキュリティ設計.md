# BSD-000-04: 共通 セキュリティ設計

## 概要

harborixおよび各アプリに共通するセキュリティ設計を定義する。

## 認証設計

### 認証フロー

```text
┌─────────┐     ┌─────────────┐     ┌──────────┐
│ ブラウザ │     │   Amplify   │     │ Cognito  │
└────┬────┘     └──────┬──────┘     └────┬─────┘
     │                 │                 │
     │ 1. ログイン画面表示               │
     │────────────────>│                 │
     │                 │                 │
     │ 2. 認証情報入力  │                 │
     │────────────────>│                 │
     │                 │                 │
     │                 │ 3. 認証リクエスト │
     │                 │────────────────>│
     │                 │                 │
     │                 │ 4. トークン発行   │
     │                 │<────────────────│
     │                 │                 │
     │ 5. トークン保存  │                 │
     │<────────────────│                 │
     │                 │                 │
     │ 6. 認証済み状態  │                 │
     │<────────────────│                 │
     └─────────────────┴─────────────────┘
```

### トークン管理

| トークン種類 | 用途 | 有効期限 | 保存場所 |
| ------------ | ---- | -------- | -------- |
| ID Token | ユーザー情報取得 | 1時間 | メモリ |
| Access Token | API認証 | 1時間 | メモリ |
| Refresh Token | トークン更新 | 30日 | Secure Storage |

### トークンリフレッシュ

```text
┌─────────┐     ┌─────────────┐     ┌──────────┐
│ ブラウザ │     │   Amplify   │     │ Cognito  │
└────┬────┘     └──────┬──────┘     └────┬─────┘
     │                 │                 │
     │ 1. APIリクエスト │                 │
     │────────────────>│                 │
     │                 │                 │
     │      2. Access Token期限切れ検知   │
     │                 │                 │
     │                 │ 3. Refresh Token送信
     │                 │────────────────>│
     │                 │                 │
     │                 │ 4. 新トークン発行 │
     │                 │<────────────────│
     │                 │                 │
     │ 5. APIリクエスト再実行             │
     │<────────────────│                 │
     └─────────────────┴─────────────────┘
```

### セッション管理

| 項目 | 設定値 |
| ---- | ------ |
| セッション有効期間 | 7日間 |
| 同時ログイン | 許可（デバイス制限なし） |
| ログアウト | 全デバイスからログアウト可能 |
| 自動ログアウト | ブラウザ閉じてもセッション維持 |

## 認可設計

### アクセス制御モデル

```text
┌─────────────────────────────────────────────────────┐
│                    ユーザー                          │
│                       │                             │
│         ┌─────────────┼─────────────┐               │
│         ▼             ▼             ▼               │
│    ┌─────────┐  ┌─────────┐  ┌─────────┐           │
│    │harborix │  │coinship │  │ libship │  ...      │
│    │  基盤   │  │         │  │         │           │
│    └────┬────┘  └────┬────┘  └────┬────┘           │
│         │            │            │                 │
│         ▼            ▼            ▼                 │
│    ┌─────────────────────────────────────┐         │
│    │      自分のデータのみアクセス可能     │         │
│    │         (Row Level Security)        │         │
│    └─────────────────────────────────────┘         │
└─────────────────────────────────────────────────────┘
```

### Row Level Security（RLS）ポリシー

#### 基本ポリシー

```sql
-- ユーザーは自分のデータのみ参照可能
CREATE POLICY "Users can view own data"
ON table_name FOR SELECT
USING (auth.uid() = user_id);

-- ユーザーは自分のデータのみ作成可能
CREATE POLICY "Users can insert own data"
ON table_name FOR INSERT
WITH CHECK (auth.uid() = user_id);

-- ユーザーは自分のデータのみ更新可能
CREATE POLICY "Users can update own data"
ON table_name FOR UPDATE
USING (auth.uid() = user_id);

-- ユーザーは自分のデータのみ削除可能
CREATE POLICY "Users can delete own data"
ON table_name FOR DELETE
USING (auth.uid() = user_id);
```

#### サービス別ポリシー例

| サービス | テーブル | ポリシー |
| -------- | -------- | -------- |
| harborix | users | 自分のレコードのみ |
| harborix | user_settings | 自分のレコードのみ |
| coinship | accounts | 自分のレコードのみ |
| coinship | transactions | 自分のレコードのみ |
| libship | books | 自分のレコードのみ |
| fanship | oshis | 自分のレコードのみ |
| fanship | shared_profiles | 公開設定されたもののみ他者も参照可 |

### API認可

```text
┌─────────┐     ┌─────────────┐     ┌──────────┐
│フロントエンド│     │  Backend   │     │ Supabase │
└────┬────┘     └──────┬──────┘     └────┬─────┘
     │                 │                 │
     │ 1. API Request  │                 │
     │   + JWT Token   │                 │
     │────────────────>│                 │
     │                 │                 │
     │      2. JWT検証  │                 │
     │      (署名・有効期限)              │
     │                 │                 │
     │                 │ 3. DB Query     │
     │                 │   + JWT Token   │
     │                 │────────────────>│
     │                 │                 │
     │                 │   4. RLSで自動   │
     │                 │   フィルタリング │
     │                 │                 │
     │                 │ 5. 結果返却      │
     │                 │<────────────────│
     │                 │                 │
     │ 6. Response     │                 │
     │<────────────────│                 │
     └─────────────────┴─────────────────┘
```

## データ保護

### 通信の暗号化

| 区間 | 方式 |
| ---- | ---- |
| ブラウザ ↔ Vercel | HTTPS (TLS 1.2+) |
| Vercel ↔ Backend API | HTTPS (TLS 1.2+) |
| Backend API ↔ Supabase | HTTPS (TLS 1.2+) |
| Backend API ↔ Cognito | HTTPS (TLS 1.2+) |

### 保存データの暗号化

| データ | 暗号化方式 |
| ------ | ---------- |
| データベース | Supabase標準（AES-256） |
| ストレージ | Supabase Storage（AES-256） |
| バックアップ | 暗号化済み |

### 機密データの取り扱い

| データ種別 | 保存場所 | 暗号化 | アクセス制御 |
| ---------- | -------- | ------ | ------------ |
| パスワード | Cognito | ハッシュ化 | Cognito管理 |
| メールアドレス | Cognito + DB | 平文 | RLS |
| アクセストークン | メモリ | - | ブラウザ内のみ |
| リフレッシュトークン | Secure Storage | - | HttpOnly |

## 脆弱性対策

### インジェクション対策

| 攻撃 | 対策 |
| ---- | ---- |
| SQLインジェクション | Supabase Client使用（パラメータ化）、RLS |
| NoSQLインジェクション | 該当なし |
| OSコマンドインジェクション | 該当なし（サーバーレス） |
| LDAPインジェクション | 該当なし |

### XSS対策

| 対策 | 実装方法 |
| ---- | -------- |
| 出力エスケープ | React自動エスケープ |
| CSP | Content-Security-Policy ヘッダー |
| HttpOnly Cookie | 認証トークン保護 |

```text
Content-Security-Policy:
  default-src 'self';
  script-src 'self';
  style-src 'self' 'unsafe-inline';
  img-src 'self' data: https:;
  connect-src 'self' https://*.supabase.co https://cognito-idp.*.amazonaws.com;
```

### CSRF対策

| 対策 | 実装方法 |
| ---- | -------- |
| SameSite Cookie | Strict または Lax |
| Origin検証 | バックエンドでOriginヘッダー検証 |
| カスタムヘッダー | X-Requested-With 必須 |

### その他の対策

| 脆弱性 | 対策 |
| ------ | ---- |
| クリックジャッキング | X-Frame-Options: DENY |
| MIMEスニッフィング | X-Content-Type-Options: nosniff |
| 情報漏洩 | エラーメッセージの汎用化 |
| ブルートフォース | Cognitoレート制限、アカウントロック |

## セキュリティヘッダー

```text
# 必須ヘッダー
Strict-Transport-Security: max-age=31536000; includeSubDomains
X-Frame-Options: DENY
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Referrer-Policy: strict-origin-when-cross-origin
Permissions-Policy: camera=(), microphone=(), geolocation=()
```

## 監査ログ

### ログ対象イベント

| イベント | ログレベル | 記録内容 |
| -------- | ---------- | -------- |
| ログイン成功 | INFO | ユーザーID、タイムスタンプ、IP |
| ログイン失敗 | WARN | 試行メール、タイムスタンプ、IP |
| ログアウト | INFO | ユーザーID、タイムスタンプ |
| パスワード変更 | INFO | ユーザーID、タイムスタンプ |
| データ作成 | DEBUG | ユーザーID、テーブル名、レコードID |
| データ更新 | DEBUG | ユーザーID、テーブル名、レコードID |
| データ削除 | INFO | ユーザーID、テーブル名、レコードID |
| 認可エラー | WARN | ユーザーID、リソース、アクション |

### ログ形式

```json
{
  "timestamp": "2026-02-13T10:30:00Z",
  "level": "INFO",
  "event": "login_success",
  "user_id": "uuid-xxxx",
  "ip": "xxx.xxx.xxx.xxx",
  "user_agent": "Mozilla/5.0...",
  "details": {}
}
```

## セキュリティチェックリスト

### 開発時

- [ ] 依存パッケージの脆弱性チェック（npm audit）
- [ ] 機密情報のハードコーディング禁止
- [ ] 入力値バリデーションの実装
- [ ] エラーメッセージの汎用化

### デプロイ時

- [ ] 環境変数の設定確認
- [ ] HTTPSの有効化確認
- [ ] セキュリティヘッダーの設定確認
- [ ] CORSの設定確認

### 運用時

- [ ] 定期的な依存パッケージ更新
- [ ] ログの定期確認
- [ ] 不審なアクセスの監視

## 変更履歴

- 2026-02-13: 初版作成
